

\documentclass[DM,authoryear,toc]{lsstdoc}
% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html

% Package imports go here.

% Local commands go here.

% To add a short-form title:
% \title[Short title]{Title}
\title{S17B HSC PDR1 Reprocessing Report}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{%
Hsin-Fang Chiang, Greg Daues, and the NCSA team
}

\setDocRef{TEST-31}

\date{\today}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
This document captures information about the large scale HSC reprocessing we performed in Cycle S17B.
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYY-MM-DD}{Unreleased.}{Hsin-Fang Chiang}
}

\begin{document}

% Create the title page.
% Table of contents is added automatically with the "toc" class option.
\maketitle

% ADD CONTENT HERE
\section{Dataset Information}
The input dataset is the HSC Strategic Survey Program (SSP) Public Data Release 1 (PDR1) \citep{2017arXiv170208449A}.
The PDR1 dataset has been transferred to the LSST GPFS storage /datasets by \jira{DM-9683} and the butler repo is available at /datasets/hsc/repo.

It includes 5654 visits in 7 bands: HSC-G, HSC-R, HSC-I, HSC-Y, HSC-Z, NB0816, NB0921. Their visit IDs are visitId-SSPPDR1.txt.  The official release site is at https://hsc-release.mtk.nao.ac.jp/
The survey has three layers and includes 8 fields.
\begin{enumerate}
\item
UDEEP: SSP{\_}UDEEP{\_}SXDS, SSP{\_}UDEEP{\_}COSMOS
\item
DEEP: SSP{\_}DEEP{\_}ELAIS{\_}N1, SSP{\_}DEEP{\_}DEEP2{\_}3, SSP{\_}DEEP{\_}XMM(S){\_}LSS, SSP{\_}DEEP{\_}COSMOS
\item
WIDE: SSP{\_}WIDE, SSP{\_}AEGIS
\end{enumerate}

The number of visits in each field and band is summarized in the following table.

\input{datasetTable}

The tract IDs for each field, obtained
from https://hsc-release.mtk.nao.ac.jp/doc/index.php/database/
is summarized in the following table.

\input{tractTable}

Plots of tracts and patches can be found on  https://hsc-release.mtk.nao.ac.jp/doc/index.php/data/. In S17B, more tracts than listed were processed.

\section{Hardware}
The processing was done using the Verification Cluster.
The Verification Cluster consists of 48 Dell C6320 nodes with 24 physical cores (2 sockets, 12 cores per processor) and 128 GB RAM. As such, the system provides a total of 1152 physical cores.
lsst-dev01 is a system with 24 physical cores, 256 GB RAM, running the latest CentOS 7.x that serves as the front end of the Verification Cluster.

The Verification Cluster runs the Simple Linux Utility for Resource Management (SLURM) cluster management and job scheduling system. lsst-dev01 runs the SLURM controller and serves as the login or head node , enabling LSST DM users to submit SLURM jobs to the Verification Cluster.

lsst-dev01 and the Verification Cluster utilize the General Parallel File System (GPFS) to provided shared-disk across all of the nodes. The GPFS will have spaces for archived datasets and scratch space to support computation/analysis.



\section{Software}

The LSST software stack is used. A shared software stack on the GPFS file systems, suitable for computation on the Verification Cluster, has been provided and is maintained by Science Pipelines and is available under /software/lsstsw.

The stack version of $w{\_}2017{\_}17$, published on 26-Apr-2017, was used.
Besides, the master branch of $meas{\_}mosaic$, $obs{\_}subaru$, and $ctrl{\_}pool$ from 7-May-2017 and built with $w{\_}2017{\_}17$ was used.
This is equivalent to the week 17 tag with \jira{DM-10315}, \jira{DM-10449}, and \jira{DM-10430}.

Unless otherwise noted, the HSC default config in the stack is used, including the task defaults and $obs{\_}subaru$'s overrides.
That implies the PS1 reference catalog $ps1{\_}pv3{\_}3pi{\_}20170110$ in the LSST format (HTM indexed) is used (/datasets/refcats/htm/ps1{\_}pv3{\_}3pi{\_}20170110/).
The calibration dataset is the 20170105 version from Paul Price; the calibration repo is located at /datasets/hsc/calib/20170105 from \jira{DM-9978}.
The externally provided bright object masks (butler type "brightObjectMask") of version "Arcturus" (\jira{DM-10436}) are added to the repo and applied in coaddDriver.assembleCoadd.

\subsection{Pipeline steps and configs}
\begin{enumerate}
\item
makeSkyMap.py
\item
singleFrameDriver.py     Ignore ccd=9 which has bad amps and results not trustworthy even if processCcd passes
\item
mosaic.py
\item
coaddDriver.py   Make config.assembleCoadd.subregionSize small enough so a full stack of images can fit into memory at once; a trade-off between memory and i/o but doesn't matter scientifically, as the pixels are independent.
\item
multiBandDriver.py
forcedPhotCcd.py   Note: it was added late and hence was not run in the RC processing
\end{enumerate}

Operational configurations, such as logging configurations in $ctrl{\_}pool$, different from the tagged stack may be used (e.g. \jira{DM-10430}).

In the full PDR1 reprocessing, everything was run with the same stack version and config. Reproducible failures are noted below, but no reprocessing is done with a newer software version.

This stack version had a known science problem about bad ellipticity residuals as reported in \jira{DM-10482}; the bug fix \jira{DM-10688} was merged to the stack on May 30 and hence was not applied in this reprocessing campaign.

\subsection{Units of independent execution}

These pipelines will be run no smaller than these units:
\begin{enumerate}
\item
makeSkyMap.py  One SkyMap for everything
\item
singleFrameDriver.py  ccd (typically run per visit)
\item
mosaic.py tract x filter, including all visits overlapping that tract in that filter.
\item
coaddDriver.py patch x filter, including all visits overlapping that patch in that filter. (typically run per tract)
\item
multiBandDriver.py  patch, including all filters. (typically run per tract)
\item
forcedPhotCcd.py  ccd
\end{enumerate}
Data of different layers (DEEP/UDEEP/WIDE) are processed separately.

\subsection{Example commands for processing}
\begin{enumerate}
\item
\begin{verbatim}
makeSkyMap.py  makeSkyMap.py /datasets/hsc/repo --rerun private/username/path
\end{verbatim}
\item
\begin{verbatim}
singleFrameDriver.py  singleFrameDriver.py /datasets/hsc/repo
  --rerun private/username/path/sfm --batch-type slurm
  --mpiexec='-bind-to socket' --cores 24 --time 600 --job jobName2
  --id ccd=0..8^10..103 visit=444
\end{verbatim}
\item
\begin{verbatim}
mosaic.py mosaic.py /datasets/hsc/repo --rerun private/username/path/sfm:private/username/path/mosaic
   --numCoresForRead=12 --id ccd=0..8^10..103 visit=444^446^454^456
   tract=9856 --diagnostics --diagDir=/path/to/mosaic/diag/dir/
\end{verbatim}
\item
\begin{verbatim}
coaddDriver.py coaddDriver.py /datasets/hsc/repo --rerun private/username/path/mosaic:private/username/path/coadd
  --batch-type=slurm --mpiexec='-bind-to socket' --job jobName4
  --time 600 --nodes 1 --procs 12 --id tract=9856 filter=HSC-Y
  --selectId ccd=0..8^10..103 visit=444^446^454^456
\end{verbatim}
\item
\begin{verbatim}
multiBandDriver.py  multiBandDriver.py /datasets/hsc/repo --rerun private/username/path/coadd:private/username/path/multiband
  --batch-type=slurm --mpiexec='-bind-to socket' --job jobName5
  --time 5000 --nodes 1 --procs 12 --id tract=9856 filter=HSC-Y^HSC-I
\end{verbatim}
\item
\begin{verbatim}
forcedPhotCcd.py  forcedPhotCcd.py /datasets/hsc/repo --rerun private/username/path/multiband:private/username/path/forced
   -j 12 --id ccd=0..8^10..103 visit=444
\end{verbatim}
\end{enumerate}


% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
\bibliography{lsst,lsst-dm,refs_ads,refs,books,local}

\end{document}
